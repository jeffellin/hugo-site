+++
title =  "Wavefront And Spring Boot"
date = 2020-05-26T13:35:15-04:00
tags = ["observability","spring"]
featured_image = ""
description = "Wavefront And Spring Boot"
draft = "true"
+++



# Observing spring boot applications with Wavefront.

Wavefront is a Software as a Service produc (SaaS) part of the new Tanzu portfolio of products from VMware.  It enables monitoring of applications. Unlike prometheus the datbase is entirely managed for you.  While prometheus may work well during initial setup it quickly can become overwelmed by mountains of production data. 

Wavefront has several components.

* The Wavefront SaaS Product
* The Wavefront proxy
* SDKs and Integrtions.

Working with integrations in wavefront gives plenty of visibility into container level metrics like memory or cpu.  In many cases it is worthwhile to look deeper. This is where instrumenting your appication can help.

* Micrometer
* Spring Boot Wavefront
* The starter


## How to setup your boot project

Prequisites

  * Spring Boot 2.3 or lat4er

If you are startinga. new project the Spring Initializer can be used. Under application dependencies you can select "Wavefront". This will setup your skeleton project with everything you need to start.

If you are adding the starter to your existing project there are a few things to add to your maven pom.

1. Check your spring version. You need at least version 2.3.0 or later.
	
	```
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.3.0.RELEASE</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
   ```

2. Add Wavefront version property.

	```
	<properties>
		<java.version>1.8</java.version>
		<spring-cloud.version>Hoxton.RELEASE</spring-cloud.version>
		<wavefront.version>2.0.0</wavefront.version>
	</properties>
	```

3. Ensure your maven pom uses the spring milestone repository. If you are using a corporate maven repository make sure the jars you need are installed there or that the corporate repository mirrors the spring milestone repository.
   
   ```
   <repository>
		<id>spring-milestones</id>
		<name>Spring Milestones</name>
		<url>https://repo.spring.io/milestone</url>
	</repository>
   ```

3. Add the Wavefront starter
   
	```
	<dependency>
		<groupId>com.wavefront</groupId>
		<artifactId>wavefront-spring-boot-starter</artifactId>
	</dependency>
	```
 
4. Add the Wavefront BOM to the dependency management section.

    ```
	<dependency>
		<groupId>com.wavefront</groupId> 			 
		<artifactId>wavefront-spring-boot-bom</artifactId>
		<version>${wavefront.version}</version>
		<type>pom</type>
		<scope>import</scope>
	</dependency>
	```

5. Add the following properties to your `application.properties`

	```
	wavefront:
	application:
		name: jellin-demo
		service: hop2
	```

The application `name` is the name of your application.  the `service` is the name of the component.  In this case hop2 is a microservice in part of a larger microservice architectured system.

Once starting the app you should see a link to a wavefront account with a one time link.  This gives you access to a freemium wavefront account that you can use to view your metrics.

```
Connect to your Wavefront dashboard using this one-time use link:
https://wavefront.surf/us/K3sikjk
```

## How to view metrics

Once you are in Wavefront you can look for metrics that your application is sending. 

select Browse->Metrics

You should be presented with a list of metrics.  You can then drill through a hierarchal list of metrics to find what you are looking for.

![metrics](/wp-content/uploads/2020/05/Wavefront.png)
           
e.g. `http.server.requests.avg `

## Sending Spans

Wavefront currently includes default application dashboard.  Navingating to Applications->Application Status look for your application. Clicking here will reveal all services that are part of your application.

![Application Inventory](/wp-content/uploads/2020/05/ApplicationInventory.png)

This dashboard is built off of application spans generated by either Slueth or Open Tracing. If you have neither of these on your classpath this dashboard is likely to be empty.  

Adding `slueth` should result in tracing data being sent to Wavefront.

```
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
```

## How to calculate the 90 Percentile within wavefront.

One common scenerio is calculating the 90th percentile of inbound requests.  Micrometer which Spring Cloud Slueth is based on can send percentile data calculated on the client side.  This is generally not reccomended because as you scale your application there may be multiple applications nodes serving the same requests.  How can you rationalize the 90th percentile of 3 nodes into a single number?

Instead, it is reccomended that you enable histograms to be sent to wavefront.  This can be done via Spring `application.properties`  

```

management:
  metrics:
    distribution:
      percentiles-histogram:
        http.server.requests: true
        http.client.requests: true
```

This snippet enables histograms for the two metrics `http.server.requests` and `http.client.requests`

Restart your app and navigate to Browse->Histograms

![Wavefront Histogramsy](/wp-content/uploads/2020/05/WavefronHistograms.png)


The following query will return the 90th Percentile of the `http.server.requests` metric. 

```
percentile(90,hs("http.server.requests.m", application=k8s-jellin))
```


![Wavefront Server Requests](/wp-content/uploads/2020/05/WaveFrontServerRequests.png)


The application in the query above filters your result by that application only.  Tyou should have one line for each uri and datasource.



You can merge the histograms by service.

```
percentile(90,merge(hs("http.server.requests.m", application=k8s-jellin),service))
```

or by service AND uri

```
percentile(90,merge(hs("http.server.requests.m", application=k8s-jellin),service,uri))
```

## References
[Official Spring Boot Tutorial for Wavefront](https://docs.wavefront.com/wavefront_springboot_tutorial.html)